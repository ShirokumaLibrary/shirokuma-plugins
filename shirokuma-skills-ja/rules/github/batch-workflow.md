# バッチワークフロー

共通のエリアやテーマを持つ複数の小さい Issue を、1 ブランチ・1 PR で処理する。

## 適格性基準

バッチ処理には以下のすべてを満たす必要がある:

| 基準 | 要件 |
|------|------|
| サイズ | XS または S のみ（M 以上は個別処理） |
| 関連性 | 同一の `area:*` ラベル、または同一ファイル群に影響 |
| 独立性 | Issue 間にブロッキング依存がない（順序の優先はOK） |
| 上限 | 1 バッチ 5 Issue 以下（推奨） |

**バッチ不可:**
- 異なる `area:*` ラベルかつファイル重複なし
- TDD が必要な Issue（各 Issue に独自のテストサイクルが必要）
- M 以上のサイズの Issue を含む場合

## 品質基準

### コミット粒度

- **1 Issue = 1コミット以上** — 異なる Issue の変更を1コミットに混在させない
- `git add` は当該 Issue のファイルのみにスコープする
- 全コミットで Issue 番号を参照: `{type}: {description} (#{issue-number})`

### テスト

- 各 Issue の変更後に関連テストを実行（次の Issue に進む前に）
- テストスイートが共有される場合は、最後の Issue 完了後に1回実行

### レビュー

- バッチ全体で1つの PR
- PR 本文に **Issue 別変更サマリー** を含める（コミットから自動生成）
- セルフレビューはバッチ全体の変更をカバー

## ブランチ命名

```
{type}/{issue-numbers}-batch-{slug}
```

**type の決定:**
- 全 Issue が同一 type → その type を使用
- type が混在 → `chore` をデフォルト

**Issue 番号:** ハイフン区切り、昇順ソート。

**例:**
```
chore/794-795-798-807-batch-docs-fixes
feat/101-102-batch-button-components
fix/200-201-203-batch-form-validation
```

## PR テンプレート

```markdown
## 概要
{バッチ全体の説明}

## Issue 別変更内容

### #{N1}: {タイトル}
- {変更内容}

### #{N2}: {タイトル}
- {変更内容}

## 関連 Issue
Closes #{N1}, #{N2}, #{N3}

## テスト計画
- [ ] {検証項目}
```

## ステータス管理

### 標準ルールの例外

バッチモードは `project-items` ルールに対して以下の制御された例外を作る:

| 標準ルール | バッチ例外 |
|-----------|----------|
| 同時に In Progress は1つ | バッチの全 Issue が同時に In Progress に遷移 |
| Issue ごとにブランチ | バッチの全 Issue が1つのブランチを共有 |

### ステータス遷移

| イベント | アクション |
|---------|----------|
| バッチ開始 | 全 Issue → In Progress（一括更新） |
| PR 作成 | 全 Issue → Review（PR の `Closes` リンク経由） |
| PR マージ | 全 Issue → Done（`issues merge` で自動） |
| バッチ中断 | 完了分は In Progress のまま。中断リカバリー参照 |

## 中断リカバリー

バッチがセッション途中で中断された場合:

1. **実装完了の Issue**（変更コミット済み）: 共有ブランチ上で In Progress のまま
2. **未着手の Issue**: Backlog に戻す
3. **ブランチ**: 次回セッションでの再開のため保持
4. **復旧**: 既存ブランチ上で `working-on-issue #{remaining-issues}` で再開

`session check --fix` で中断後のステータス不整合を検出・修正する。

## バッチ候補検出

`starting-session` と `showing-github` がバッチをプロアクティブに提案するために使用する。

### 検出アルゴリズム

1. フィルタ: Backlog の XS/S サイズ Issue
2. グルーピング:
   - **第1優先**: `area:*` ラベル（完全一致）
   - **フォールバック**: タイトルからキーワード抽出（共通名詞2語以上 → 同一グループ）
3. フィルタ: 3 Issue 以上のグループ
4. 表示: 上位3グループ、グループサイズ降順

### 表示形式

```markdown
### バッチ候補
| グループ | Issue | エリア |
|---------|-------|-------|
| プラグイン修正 | #101, #102, #105 | area:plugin |
| CLI 改善 | #110, #112, #115 | area:cli |
```

## ルール

1. **適格性ゲート** — バッチ開始前にすべての基準をチェック
2. **1 Issue 1コミット以上** — Issue の変更を1コミットに混在させない
3. **スコープされたステージング** — `git add` は当該 Issue のファイルのみ
4. **Issue 間テスト** — 各 Issue の実装後に関連テストを実行
5. **1つの PR** — 1ブランチ、1 PR でバッチ全体を処理
6. **一括ステータス更新** — バッチ開始時に全 Issue を In Progress に
7. **Issue 別サマリー** — PR 本文に Issue ごとの変更概要を記載

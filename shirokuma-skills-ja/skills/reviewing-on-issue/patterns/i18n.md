# 国際化（i18n）パターン

関連: [code-quality.md](../criteria/code-quality.md)

## 設定

### ルーティング設定

```typescript
// i18n/routing.ts
import { defineRouting } from "next-intl/routing"

export const routing = defineRouting({
  locales: ["ja", "en"],
  defaultLocale: "ja",
  localePrefix: "never",  // Cookie ベース、URL プレフィックスなし
})
```

### リクエスト設定

```typescript
// i18n/request.ts
import { getRequestConfig } from "next-intl/server"
import { routing } from "./routing"

export default getRequestConfig(async ({ requestLocale }) => {
  let locale = await requestLocale
  if (!locale || !routing.locales.includes(locale as any)) {
    locale = routing.defaultLocale
  }

  return {
    locale,
    messages: (await import(`../messages/${locale}.json`)).default,
  }
})
```

## Server Components

### 必須: setRequestLocale

**重要**: すべての Server Component ページで `setRequestLocale` を呼ぶ必要がある:

```typescript
import { getTranslations, setRequestLocale } from "next-intl/server"

export default async function Page({ params }: { params: Promise<{ locale: string }> }) {
  const { locale } = await params
  setRequestLocale(locale)  // 静的レンダリングに必須!

  const t = await getTranslations("common")
  return <h1>{t("title")}</h1>
}
```

**未指定の場合**: 静的レンダリングが失敗し、翻訳は動作するが低速。

### 名前空間ベースの翻訳

```typescript
const t = await getTranslations("posts")
t("title")  // messages.posts.title

// 複数名前空間
const [tCommon, tPosts] = await Promise.all([
  getTranslations("common"),
  getTranslations("posts"),
])
```

## Client Components

```typescript
"use client"
import { useTranslations, useLocale } from "next-intl"

export function MyComponent() {
  const t = useTranslations("namespace")
  const locale = useLocale()

  return <button>{t("submit")}</button>
}
```

### Provider 付き

```typescript
import { NextIntlClientProvider } from "next-intl"

function renderWithProviders(ui: React.ReactElement, locale = "en") {
  const messages = { common: { save: "Save" } }
  return render(
    <NextIntlClientProvider locale={locale} messages={messages}>
      {ui}
    </NextIntlClientProvider>
  )
}
```

## 翻訳ファイル

### 構造

```json
// messages/ja.json
{
  "common": {
    "save": "保存",
    "cancel": "キャンセル",
    "logout": "ログアウト"
  },
  "posts": {
    "title": "記事一覧",
    "readMore": "続きを読む"
  },
  "auth": {
    "loginError": "メールアドレスまたはパスワードが正しくありません"
  }
}
```

### 補間

```json
{
  "postsCount": "{count}件の記事",
  "greeting": "{name}さん、こんにちは"
}
```

```typescript
t("postsCount", { count: 10 })  // "10件の記事"
t("greeting", { name: "田中" })  // "田中さん、こんにちは"
```

## 日付フォーマット

```typescript
const dateLocale = locale === "ja" ? "ja-JP" : "en-US"

post.publishedAt.toLocaleDateString(dateLocale, {
  year: "numeric",
  month: "long",
  day: "numeric",
})
// Japanese: "2025年11月28日"
// English: "November 28, 2025"
```

## 日本語 URL スラッグ

URL エンコードされた日本語文字はデコードが必要:

```typescript
// URL: /tag/%E6%97%A5%E6%9C%AC%E8%AA%9E
export default async function TagPage({ params }: { params: Promise<{ slug: string }> }) {
  const { slug } = await params
  const decodedSlug = decodeURIComponent(slug)  // "日本語"
  const tag = await getTagBySlug(decodedSlug)
}
```

**未デコードの場合**: 日本語タグ/カテゴリページで 404。

## テストパターン

### next-intl のモック

```typescript
// jest.setup.ts
jest.mock("next-intl", () => ({
  useTranslations: () => (key: string) => key,
  useLocale: () => "ja",
}))
```

### フル i18n でのテスト

```typescript
import { NextIntlClientProvider } from "next-intl"

const messages = {
  common: { save: "Save" },
  features: { title: "Features" },
}

function renderWithIntl(ui: React.ReactElement) {
  return render(
    <NextIntlClientProvider locale="en" messages={messages}>
      {ui}
    </NextIntlClientProvider>
  )
}
```

## 既知の問題

### Next.js 16 互換性 (Issue #2064)

- next-intl が headers を使用するため SSG ビルドが失敗
- Next.js 16 で SSG 制限が厳格化
- 確認: https://github.com/amannn/next-intl/issues/2064

### E2E テストでの i18n

```typescript
// 日英両方のテキストにマッチ
await expect(page.getByRole("button", { name: /Save|保存/i })).toBeVisible()
await expect(page.getByText(/Invalid credentials|認証エラー/i)).toBeVisible()
```

## アンチパターン

### ハードコード文字列

```typescript
// Bad
<button>Save</button>

// Good
const t = useTranslations("common")
<button>{t("save")}</button>
```

### setRequestLocale の欠落

```typescript
// Bad: setRequestLocale なし
export default async function Page({ params }) {
  const { locale } = await params
  const t = await getTranslations("common")  // 動作するが低速
}

// Good: setRequestLocale あり
export default async function Page({ params }) {
  const { locale } = await params
  setRequestLocale(locale)  // 必須!
  const t = await getTranslations("common")
}
```
